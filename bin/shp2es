#!/bin/bash

## preallocate variables
# get the base directory of the package
pkg_dir="$( cd "$( dirname `which shp2es` )" && cd ../ && pwd )"
db_type=elasticsearch

## source in necessary functions
source "$pkg_dir"/scripts/prepare_variables.sh
source "$pkg_dir"/scripts/wget_census_data.sh
source "$pkg_dir"/scripts/shp2geojson.sh
source "$pkg_dir"/scripts/format_geojson.sh
source "$pkg_dir"/scripts/remove_database.sh
source "$pkg_dir"/scripts/input_mapping.sh
source "$pkg_dir"/scripts/input_records.sh

# read options and set variables before executing functions
options='hlmf:s:i:t:H:p:re'
while getopts "$options" option
do
    case "$option" in
        h  ) h_opt; exit 0;; # HELP/documentation
        l  ) l_opt;; # data source is LOCAL (no arugment needed)
        m  ) m_opt;; # MULTIPLE files (specify directory with shapefiles)
        f  ) f_opt;; # FILE (if local and only one), directory of FILES (if local and multiple), FILE to get from census (if not local)
        s  ) s_opt;; # STATE fips code (two digit)
        i  ) i_opt;; # INDEX name
        t  ) t_opt;; # document TYPE
        H  ) H_opt;; # HOST
        p  ) p_opt;; # PORT
        r  ) r_opt;; # REMOVE database or index before reinserting records/documents
        e  ) e_opt;; # use ESBULK multiprocessing utility
        \? ) echo "Unknown option: -$OPTARG" >&2; exit 1;;
        :  ) echo "Arugment required for option -$OPTARG" >&2; exit 1;;
        *  ) echo "Unused option: -$OPTARG" >&2; exit 1;;
    esac
done

## execute the functions sourced above based on user options
wget_census_data
shp2geojson
format_geojson
remove_database
input_mapping
input_records

printf "\nComplete"
